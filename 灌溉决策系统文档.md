# 智能灌溉决策系统技术文档

## 目录

1. [系统概述](#系统概述)
2. [核心算法](#核心算法)
3. [土壤参数计算](#土壤参数计算)
4. [灌溉决策流程](#灌溉决策流程)
5. [配置参数说明](#配置参数说明)
6. [API接口说明](#api接口说明)
7. [多田块管理](#多田块管理)
8. [数据流转](#数据流转)

---

## 系统概述

### 1.1 系统架构

本系统是一个基于FAO-56蒸散发模型和传感器实测数据的智能灌溉决策系统，主要包括以下模块：

```
drought_smart_irrigation/
├── src/
│   ├── models/          # 模型层（FAO模型、AquaCrop模型）
│   ├── services/        # 服务层（灌溉决策服务）
│   ├── devices/         # 设备层（土壤传感器）
│   ├── api/             # API接口层
│   └── utils/           # 工具类
├── data/
│   ├── weather/         # 气象数据
│   ├── soil/            # 土壤数据
│   └── model_output/    # 模型输出
└── config.py            # 配置文件
```

### 1.2 技术栈

- **后端框架**: Flask
- **模型库**: pyfao56, aquacrop
- **数据处理**: pandas, numpy
- **传感器接口**: REST API
- **日志系统**: loguru


---

## 核心算法

### 2.1 土壤水分平衡方程

系统基于FAO-56土壤水分平衡模型：

```
θ(t+1) = θ(t) + P - ETc - D - R + I
```

**参数说明：**
- `θ(t)` - t时刻土壤含水量
- `P` - 降雨量
- `ETc` - 作物蒸散量
- `D` - 深层渗漏
- `R` - 地表径流
- `I` - 灌溉量

### 2.2 作物蒸散量计算

**ETc计算公式：**

```
ETc = Kc × ET0
```

其中：
- `ET0` - 参考作物蒸散量（通过Hargreaves或Penman-Monteith方法计算）
- `Kc` - 作物系数（根据生育阶段动态调整）

**作物系数分段计算：**

```python
# 初期阶段
Kc = Kcbini = 0.15

# 发育阶段（线性增长）
Kc = Kcbini + (Kcbmid - Kcbini) × (t - Lini) / Ldev

# 中期阶段
Kc = Kcbmid = 1.10

# 末期阶段（线性下降）
Kc = Kcbmid - (Kcbmid - Kcbend) × (t - Lmid) / Lend
```

### 2.3 灌溉决策算法

**核心决策逻辑：**

```python
# 1. 计算可用水量
available_water = current_humidity - PWP

# 2. 计算未来3天累积蒸散量
cumulative_ETc_3days = sum(ETc[today:today+3])

# 3. 判断是否需要灌溉
if cumulative_ETc_3days > available_water × irrigation_threshold:
    # 需要灌溉
    irrigation_amount = min(
        FC - current_humidity,  # 补充到田间持水量
        cumulative_ETc_3days - available_water × irrigation_threshold,
        MAX_SINGLE_IRRIGATION  # 单次最大灌溉量限制
    )
else:
    # 不需要灌溉
    irrigation_amount = 0
```


---

## 土壤参数计算

### 3.1 土壤水分特征参数

系统通过传感器历史数据统计获取三个关键土壤参数：

#### 3.1.1 饱和含水量 (SAT)

**定义：** 土壤孔隙完全充满水时的含水量

**计算方法：**
```python
# 百分比值（从传感器数据获取）
SAT_percent = max(历史湿度数据)  # 取2024年7月1日至今的最大值

# 转换为毫米
SAT_mm = SAT_percent × conversion_factor
```

**数据来源：** 2024年7月1日至今的传感器历史数据

#### 3.1.2 田间持水量 (FC)

**定义：** 土壤充分灌溉后，重力水排出，毛管悬着水达到稳定时的含水量

**计算方法：**
```python
# 百分比值（从传感器数据获取）
FC_percent = mean(特定时段湿度数据)  # 取2024年10月15-31日的平均值

# 转换为毫米
FC_mm = FC_percent × conversion_factor
```

**数据来源：** 2024年10月15日-10月31日的传感器数据（灌溉后稳定期）

#### 3.1.3 萎蔫点 (PWP)

**定义：** 植物因缺水而永久萎蔫时的土壤含水量

**计算方法：**
```python
# 百分比值（从传感器数据获取）
PWP_percent = min(历史湿度数据)  # 取2024年7月1日至今的最小值

# 转换为毫米
PWP_mm = PWP_percent × conversion_factor
```

**数据来源：** 2024年7月1日至今的传感器历史数据

### 3.2 转换系数计算

**公式：**
```python
conversion_factor = (soil_depth / 10) × root_depth_coeff × growth_stage_coeff
```

**参数说明：**

1. **土壤深度 (soil_depth)**
   - 默认值：30 cm
   - 可配置：`IRRIGATION_CONFIG['SOIL_DEPTH_CM']`

2. **根系深度系数 (root_depth_coeff)**
   ```python
   if root_depth < 0.3m:
       root_depth_coeff = 0.5
   else:
       root_depth_coeff = 1.0
   ```
   - 数据来源：从 `wheat2024.out` 文件读取当日根系深度

3. **生育阶段系数 (growth_stage_coeff)**
   ```python
   GROWTH_STAGE_COEFFICIENTS = {
       "播种-出苗期": 0.6,
       "出苗-分蘖期": 0.7,
       "分蘖-越冬期": 0.8,
       "返青-拔节期": 0.9,
       "拔节-抽穗期": 1.0,
       "抽穗-成熟期": 0.9
   }
   ```
   - 数据来源：从 `growth_stages.csv` 文件读取当前生育阶段

### 3.3 土壤储水指标

**1. 蓄水潜力 (Storage Potential)**
```python
storage_potential = SAT - PWP  # 土壤最大可储存水量
```

**2. 有效储水量 (Effective Storage)**
```python
effective_storage = FC - PWP  # 植物可利用的水量范围
```

**3. 可利用储水量 (Available Storage)**
```python
available_storage = current_humidity - PWP  # 当前可供植物利用的水量
```

### 3.4 参数获取方式（v1.3.0 重要变更）

**系统已从"参数传递"模式改为"自动获取"模式：**

#### 旧方式（已废弃）
```python
# 调用者需要提前获取参数
max_humidity = sensor.get_max_humidity()
min_humidity = sensor.get_min_humidity()
real_humidity = sensor.get_real_humidity()

# 传递给决策函数
result = make_irrigation_decision(field_id, max_humidity, min_humidity, real_humidity)
```

#### 新方式（当前）
```python
# 只需要提供 field_id、device_id 和实时湿度
result = make_irrigation_decision(field_id, device_id, real_humidity)

# SAT/FC/PWP 自动获取流程：
# 1. 根据 field_id 查找是否有特定配置（FIELD_DATA_PERIODS）
# 2. 如果有，使用田块特定的时间段
# 3. 如果没有，使用全局默认配置（DATA_QUERY_RANGES）
# 4. 从传感器历史数据统计计算
```

#### 优势
- **减少参数传递**：降低出错概率
- **统一数据来源**：避免数据不一致
- **支持田块配置**：不同田块可使用不同时间段
- **自动化程度高**：无需手动管理土壤参数


---

## 灌溉决策流程

### 4.1 决策流程图

```
开始
  ↓
获取传感器数据（SAT, FC, PWP, 实时湿度）
  ↓
计算土壤水分参数（转换为mm）
  ↓
运行FAO模型获取未来ETc预测
  ↓
判断：当前湿度 ≤ PWP？
  ├─ 是 → 立即灌溉（补充到FC）
  └─ 否 → 继续判断
       ↓
判断：第3天累积ETc ≤ 可用水量 × 阈值？
  ├─ 是 → 水分充足，不灌溉
  └─ 否 → 继续判断
       ↓
判断：未来3天内有有效降雨（≥5mm）？
  ├─ 是 → 延迟灌溉
  └─ 否 → 计算灌溉量
       ↓
灌溉量 = min(FC - 当前湿度, 第3天累积ETc - 可用水量 × 阈值, 30mm)
  ↓
量化灌溉量（分档：0, 5, 10, 15, 20, 25, 30, 40, 50mm）
  ↓
判断：灌溉量 > 最小有效灌溉量（5mm）？
  ├─ 是 → 执行灌溉
  └─ 否 → 不灌溉
       ↓
结束
```

### 4.2 决策规则详解

#### 规则1：临界水分判断

**条件：** `current_humidity ≤ PWP`

**决策：** 立即灌溉

**灌溉量：**
```python
irrigation_amount = min(FC - current_humidity, MAX_SINGLE_IRRIGATION)
```

**说明：** 土壤水分已达到或低于萎蔫点，作物面临严重缺水风险，需立即补充水分至田间持水量。

---

#### 规则2：水分充足判断

**条件：** `cumulative_ETc_3days ≤ available_water × irrigation_threshold`

**决策：** 不灌溉

**说明：** 
- `cumulative_ETc_3days` - 未来3天累积蒸散量
- `available_water` - 当前可用水量（current_humidity - PWP）
- `irrigation_threshold` - 灌溉阈值（默认0.6，根据生育阶段调整）

当前土壤水分足以支撑未来3天的作物需水，无需灌溉。

---

#### 规则3：降雨预报判断

**条件：** 未来3天内有降雨预报

**子规则3.1：有效降雨**
- **条件：** `rain_amount ≥ 5mm` 且 `days_to_rain ≤ 3`
- **决策：** 延迟灌溉
- **说明：** 近期有足够降雨，可延迟灌溉

**子规则3.2：小雨或远期降雨**
- **条件：** `rain_amount < 5mm` 或 `days_to_rain > 2`
- **决策：** 部分灌溉
- **灌溉量：**
  ```python
  # 注意：代码中使用的是 2 days，不是 3 days
  two_days_from_now = now + pd.to_timedelta('2 days')
  if first_rain_day > two_days_from_now:
      irrigation_amount = cumulative_ETc_until_rain - available_water × irrigation_threshold
  ```
- **说明：** 如果降雨在2天之后，需要计算部分灌溉量以支撑到降雨前

---

#### 规则4：常规灌溉计算

**条件：** 无降雨预报且水分不足

**灌溉量计算：**
```python
irrigation_amount = min(
    FC - current_humidity,           # 补充到田间持水量
    cumulative_ETc_3days - available_water × irrigation_threshold,  # 满足未来3天需水
    MAX_SINGLE_IRRIGATION            # 单次最大灌溉量（30mm）
)
```

**量化处理：**
```python
# 灌溉量分档
IRRIGATION_LEVELS = [0, 5, 10, 15, 20, 25, 30, 40, 50]

# 向上取整到最近档位
for level in IRRIGATION_LEVELS:
    if irrigation_amount <= level:
        return level
```

**最小有效灌溉量判断：**
```python
if irrigation_amount < MIN_EFFECTIVE_IRRIGATION:  # 5mm
    irrigation_amount = 0  # 灌溉量过小，不执行
```

### 4.3 决策参数配置

| 参数名称 | 默认值 | 说明 | 配置项 |
|---------|--------|------|--------|
| 灌溉阈值 | 0.6 | 基础灌溉触发阈值 | `IRRIGATION_THRESHOLD` |
| 最小有效灌溉量 | 5.0 mm | 低于此值不灌溉 | `MIN_EFFECTIVE_IRRIGATION` |
| 最大单次灌溉量 | 30.0 mm | 单次灌溉上限 | `MAX_SINGLE_IRRIGATION` |
| 降雨预报天数 | 3 天 | 考虑降雨的时间窗口 | `RAIN_FORECAST_DAYS` |
| 最小有效降雨量 | 5.0 mm | 有效降雨的最小值 | `MIN_RAIN_AMOUNT` |
| 预测天数 | 15 天 | 模型预测的最大天数 | `MAX_FORECAST_DAYS` |


---

## 配置参数说明

### 5.1 作物参数 (CROP_PARAMS)

用于FAO-56模型计算作物蒸散量。

```python
CROP_PARAMS = {
    'Kcbini': 0.15,   # 初期基础作物系数
    'Kcbmid': 1.10,   # 盛长期基础作物系数
    'Kcbend': 0.20,   # 末期基础作物系数
    'Lini': 20,       # 初期阶段天数
    'Ldev': 50,       # 速生期天数
    'Lmid': 70,       # 盛长期天数
    'Lend': 30,       # 末期天数
    'hmax': 1.0       # 最大株高（米）
}
```

**参数说明：**
- **Kcb系数**：反映作物在不同生育阶段的需水特性
- **L天数**：定义各生育阶段的持续时间
- **hmax**：影响作物对风速和湿度的响应

### 5.2 土壤参数 (SOIL_PARAMS)

用于土壤水分平衡计算。

```python
SOIL_PARAMS = {
    'thetaFC': 0.327,   # 田间持水量（体积含水量）
    'thetaWP': 0.10,    # 萎蔫点含水量（体积含水量）
    'theta0': 0.327,    # 初始土壤含水量
    'Zrini': 0.20,      # 初始根系深度（米）
    'Zrmax': 1.5,       # 最大根系深度（米）
    'pbase': 0.55,      # 无胁迫亏缺比例基值
    'Ze': 0.10,         # 表层蒸发土层厚度（米）
    'REW': 9.0          # 易蒸发水量（mm）
}
```

**参数说明：**
- **thetaFC/thetaWP**：土壤水分特征曲线的关键点
- **Zr参数**：根系发育动态，影响可利用土层深度
- **pbase**：水分胁迫阈值，冬小麦典型值0.55
- **Ze/REW**：土壤蒸发层参数

### 5.3 灌溉决策配置 (IRRIGATION_CONFIG)

控制灌溉决策行为的核心参数。

```python
IRRIGATION_CONFIG = {
    'DEFAULT_FIELD_ID': '1810564502987649024',  # 默认田块ID
    'DEFAULT_DEVICE_ID': '16031600028481',      # 默认设备ID
    'SOIL_DEPTH_CM': 30,                        # 土壤深度（厘米）
    'MAX_FORECAST_DAYS': 15,                    # 最大预报天数
    'IRRIGATION_THRESHOLD': 0.6,                # 基础灌溉阈值
    'MIN_EFFECTIVE_IRRIGATION': 5.0,            # 最小有效灌溉量（mm）
    'MAX_SINGLE_IRRIGATION': 30.0,              # 单次最大灌溉量（mm）
    'IRRIGATION_LEVELS': [0, 5, 10, 15, 20, 25, 30, 40, 50],  # 灌溉量分档
    'MIN_RAIN_AMOUNT': 5.0,                     # 最小有效降雨量（mm）
    'RAIN_FORECAST_DAYS': 3,                    # 降雨预报考虑天数
    'ROOT_DEPTH_THRESHOLD': 0.3,                # 根系深度阈值（米）
    'HUMIDITY_MIN_RANGE': 0.0,                  # 湿度最小范围
    'HUMIDITY_MAX_RANGE': 100.0,                # 湿度最大范围
    'MIN_FORECAST_DATA_DAYS': 3                 # 最小预测数据天数
}
```

### 5.4 生育阶段系数 (GROWTH_STAGE_COEFFICIENTS)

根据作物生育阶段调整灌溉阈值。

```python
GROWTH_STAGE_COEFFICIENTS = {
    "播种-出苗期": 0.6,   # 需水较少
    "出苗-分蘖期": 0.7,   # 需水逐渐增加
    "分蘖-越冬期": 0.8,   # 需水中等
    "返青-拔节期": 0.9,   # 需水较多
    "拔节-抽穗期": 1.0,   # 需水最多（关键期）
    "抽穗-成熟期": 0.9    # 需水减少
}
```

**实际灌溉阈值计算：**
```python
actual_threshold = IRRIGATION_THRESHOLD × growth_stage_coeff
```

**示例：**
- 拔节-抽穗期：`0.6 × 1.0 = 0.6`（最严格）
- 播种-出苗期：`0.6 × 0.6 = 0.36`（最宽松）

### 5.5 传感器配置 (SOIL_SENSOR_DEFAULTS)

传感器数据获取和处理的默认参数。

```python
SOIL_SENSOR_DEFAULTS = {
    # 默认数据
    'DEFAULT_SAT': 35.5,           # 默认饱和含水量（%）
    'DEFAULT_FC': 25.0,            # 默认田间持水量（%）
    'DEFAULT_PWP': 15.2,           # 默认萎蔫点（%）
    'DEFAULT_REAL_HUMIDITY': 25.0, # 默认实时湿度（%）
    
    # API配置
    'API_TIMEOUT': 15,             # API超时时间（秒）
    'API_MAX_RETRIES': 3,          # API最大重试次数
    'API_MAX_WAIT_TIME': 10,       # API最大等待时间（秒）
    
    # 熔断器配置
    'CIRCUIT_BREAKER_FAILURE_THRESHOLD': 5,   # 熔断器失败阈值
    'CIRCUIT_BREAKER_RECOVERY_TIMEOUT': 60,   # 熔断器恢复超时（秒）
    
    # 数据查询配置
    'DEFAULT_HISTORY_DAYS': 30,    # 默认历史数据天数
    'SMOOTH_WINDOW': 3             # 数据平滑窗口
}
```

### 5.6 数据查询范围 (DATA_QUERY_RANGES)

定义传感器数据的查询时间范围（全局默认配置）。

```python
DATA_QUERY_RANGES = {
    # SAT/PWP数据查询范围
    'MOISTURE_DATA_START_YEAR': 2024,
    'MOISTURE_DATA_START_MONTH': 7,
    'MOISTURE_DATA_START_DAY': 1,
    
    # FC数据查询范围
    'FC_DATA_START_YEAR': 2024,
    'FC_DATA_START_MONTH': 10,
    'FC_DATA_START_DAY': 15,
    'FC_DATA_END_YEAR': 2024,
    'FC_DATA_END_MONTH': 10,
    'FC_DATA_END_DAY': 31
}
```

**说明：**
- **SAT/PWP**：使用长期历史数据（7月至今）获取极值
- **FC**：使用灌溉后稳定期数据（10月15-31日）获取平均值
- **作用**：作为全局默认配置，当田块没有特定配置时使用

### 5.7 田块数据查询配置 (FIELD_DATA_PERIODS)

支持为不同田块配置不同的数据查询时间段（v1.3.0 新增）。

```python
FIELD_DATA_PERIODS = {
    '1810564502987649024': {  # 田块ID
        'sat_pwp': {
            'start_date': '2024-07-01',
            'end_date': None  # None 表示到当前日期
        },
        'fc': {
            'start_date': '2024-10-15',
            'end_date': '2024-10-31'
        }
    },
    '1810564502987649025': {  # 另一个田块（不同时间段）
        'sat_pwp': {
            'start_date': '2024-08-01',  # 不同的开始时间
            'end_date': None
        },
        'fc': {
            'start_date': '2024-11-01',  # 不同的FC时段
            'end_date': '2024-11-15'
        }
    }
    # 其他田块如果不配置，会使用全局默认值
}
```

**配置说明：**
- 如果田块有特定配置，优先使用田块配置
- 如果没有配置，使用全局默认配置（DATA_QUERY_RANGES）
- 支持动态添加新田块配置
- `end_date` 为 `None` 表示使用到当前日期

**获取方法：**
```python
@staticmethod
def get_field_data_periods(field_id):
    """获取田块特定的数据查询时间段配置
    
    Args:
        field_id: 田块ID
        
    Returns:
        dict: 包含 sat_pwp 和 fc 时间段配置的字典
        None: 如果没有特定配置，使用全局默认配置
    """
    if not field_id:
        return None
    return Config.FIELD_DATA_PERIODS.get(field_id)
```

**使用场景：**
- 不同田块的种植时间不同
- 不同田块的灌溉历史不同
- 需要更精确的田块特定参数


---

## API接口说明

### 6.1 土壤数据接口

**接口地址：** `GET /api/soil_data`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| field_id | string | 否 | 田块ID，默认使用配置中的默认田块 |

**响应示例：**
```json
{
  "max_humidity": 35.5,
  "min_humidity": 15.2,
  "real_humidity": 25.8,
  "sat": 32.0,
  "fc": 28.5,
  "pwp": 15.0,
  "is_real_data": true,
  "timestamp": "2024-07-15 12:34:56",
  "unit": "%",
  "storage_potential": 51.0,
  "effective_storage": 40.5,
  "available_storage": 32.4
}
```

**字段说明：**
- `max_humidity` - 历史最大湿度（%）
- `min_humidity` - 历史最小湿度（%）
- `real_humidity` - 当前实时湿度（%）
- `sat` - 饱和含水量（%）
- `fc` - 田间持水量（%）
- `pwp` - 萎蔫点（%）
- `is_real_data` - 是否为真实传感器数据
- `storage_potential` - 蓄水潜力（mm）
- `effective_storage` - 有效储水量（mm）
- `available_storage` - 可利用储水量（mm）

---

### 6.2 灌溉决策接口

**接口地址：** `GET /api/irrigation_recommendation`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| field_id | string | 否 | 田块ID，默认使用配置中的默认田块 |

**响应示例：**
```json
{
  "status": "success",
  "data": {
    "irrigation_amount": 15.0,
    "message": "当前土壤体积含水量为：25.80%, 今日需灌溉15.0mm,近期无降雨预报",
    "calculated_deficit": 32.4,
    "timestamp": "2024-07-15 12:34:56",
    "soil_moisture_status": "insufficient",
    "next_check_time": "2024-07-16 12:34:56",
    "data_quality": "real"
  }
}
```

**字段说明：**
- `irrigation_amount` - 建议灌溉量（mm）
- `message` - 决策说明信息
- `calculated_deficit` - 计算的水分亏缺量（mm）
- `soil_moisture_status` - 土壤水分状态（sufficient/insufficient）
- `next_check_time` - 下次检查时间
- `data_quality` - 数据质量（real/partial/default）

**重要说明（v1.3.0）：**
- SAT/FC/PWP 参数自动从传感器获取（基于 field_id 的历史数据统计）
- 系统会根据 field_id 查找对应的 device_id
- 如果田块有特定配置（FIELD_DATA_PERIODS），使用特定时间段
- 如果没有特定配置，使用全局默认配置（DATA_QUERY_RANGES）

**后端调用示例：**
```python
# 新版本调用方式（v1.3.0）
result = irrigation_service.make_irrigation_decision(
    field_id,       # 田块ID
    device_id,      # 设备ID（自动从田块配置获取）
    real_humidity   # 实时湿度（从传感器获取）
)

# 注意：不再需要传入 max_humidity 和 min_humidity
# SAT/FC/PWP 会自动从传感器历史数据统计获取
```

---

### 6.3 触发决策接口

**接口地址：** `POST /api/make_decision`

**请求方式：** POST

**请求参数：** 无（使用默认田块配置）

**响应示例：**
```json
{
  "status": "success",
  "message": "灌溉决策任务已启动/完成"
}
```

**说明：** 
- 手动触发灌溉决策计算
- 系统会自动获取传感器数据（包括 SAT/FC/PWP）
- 自动运行FAO模型（如果当天未运行）
- 生成完整的灌溉决策

**处理流程：**
```python
# 1. 获取传感器数据
soil_sensor = SoilSensor(device_id, field_id)
sensor_data = soil_sensor.get_current_data()
real_humidity = sensor_data['real_humidity']

# 2. 生成决策（SAT/FC/PWP 自动获取）
result = irrigation_service.make_irrigation_decision(
    field_id,
    device_id,
    real_humidity
)

# 3. 返回结果
return {'status': 'success', 'message': '灌溉决策任务已启动/完成'}
```

---

### 6.4 土壤湿度历史数据接口

**接口地址：** `GET /api/soil_humidity_history`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| days | integer | 否 | 查询天数，默认30天，最大365天 |

**响应示例：**
```json
{
  "status": "success",
  "data": {
    "dates": ["2024-06-15", "2024-06-16", "..."],
    "soilHumidity10Value": [18.5, 19.2, "..."],
    "soilHumidity20Value": [22.3, 22.8, "..."],
    "soilHumidity30Value": [25.1, 25.6, "..."]
  }
}
```

**字段说明：**
- `dates` - 日期数组
- `soilHumidity10Value` - 10cm深度湿度数据
- `soilHumidity20Value` - 20cm深度湿度数据
- `soilHumidity30Value` - 30cm深度湿度数据

---

### 6.5 ETref和ETc历史数据接口

**接口地址：** `GET /api/et_history`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| days | integer | 否 | 查询天数，默认30天 |

**响应示例：**
```json
{
  "status": "success",
  "data": {
    "dates": ["2024-06-15", "2024-06-16", "..."],
    "etref": [3.2, 3.5, "..."],
    "etc": [2.8, 3.1, "..."],
    "count": 30
  }
}
```

**字段说明：**
- `etref` - 参考作物蒸散量（mm/day）
- `etc` - 作物蒸散量（mm/day）

---

### 6.6 田块列表接口

**接口地址：** `GET /api/fields`

**响应示例：**
```json
{
  "status": "success",
  "data": [
    {
      "field_id": "1810564502987649024",
      "device_id": "16031600028481",
      "field_name": "F1",
      "crop_type": "小麦",
      "area": 12,
      "description": "大户试验地"
    }
  ],
  "count": 1,
  "timestamp": "2024-07-15 12:34:56"
}
```

---

### 6.7 天气数据接口

**接口地址：** `GET /api/weather_data`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| days | integer | 否 | 查询天数，默认7天 |
| type | string | 否 | 数据类型，默认daily |
| start_date | string | 否 | 开始日期（YYYY-MM-DD） |
| end_date | string | 否 | 结束日期（YYYY-MM-DD） |

**响应示例：**
```json
{
  "status": "ok",
  "data": {
    "dates": ["2024-07-15", "2024-07-16", "..."],
    "max_temperature": [32.5, 33.2, "..."],
    "min_temperature": [18.3, 19.1, "..."],
    "precipitation": [0, 5.2, "..."],
    "solar_radiation": [22.5, 23.1, "..."],
    "wind_speed": [2.3, 2.8, "..."],
    "relative_humidity": [65, 68, "..."],
    "reference_evapotranspiration": [4.2, 4.5, "..."]
  },
  "data_type": "daily",
  "timestamp": "2024-07-15 12:34:56"
}
```

---

### 6.8 系统健康检查接口

**接口地址：** `GET /health`

**响应示例：**
```json
{
  "status": "ok",
  "message": "系统健康检查完成",
  "checks": {
    "data_directory": true,
    "static_directory": true
  },
  "timestamp": "2024-07-15 12:34:56"
}
```


---

## 多田块管理

### 7.1 田块配置

系统支持多田块管理，每个田块可以配置独立的设备和属性。

**配置示例：**
```python
FIELDS_CONFIG = [
    {
        'field_id': '1810564502987649024',
        'device_id': '16031600028481',
        'field_name': 'F1',
        'crop_type': '小麦',
        'area': 12,  # 面积（亩）
        'description': '大户试验地'
    },
    {
        'field_id': '1810564502987649025',
        'device_id': '16031600028482',
        'field_name': 'F2',
        'crop_type': '小麦',
        'area': 15,
        'description': '示范田'
    }
]
```

### 7.2 田块间的差异

#### 7.2.1 独立的传感器数据

每个田块通过独立的设备ID获取传感器数据：

```python
# 田块F1的数据
soil_sensor_f1 = SoilSensor(device_id='16031600028481', field_id='1810564502987649024')
data_f1 = soil_sensor_f1.get_current_data()

# 田块F2的数据
soil_sensor_f2 = SoilSensor(device_id='16031600028482', field_id='1810564502987649025')
data_f2 = soil_sensor_f2.get_current_data()
```

**差异化的数据包括：**
- 饱和含水量（SAT）
- 田间持水量（FC）
- 萎蔫点（PWP）
- 实时湿度
- 历史湿度数据

#### 7.2.2 独立的灌溉决策

每个田块根据自身的传感器数据生成独立的灌溉决策：

```python
# 田块F1的决策
decision_f1 = irrigation_service.make_irrigation_decision(
    field_id='1810564502987649024',
    max_humidity=data_f1['max_humidity'],
    min_humidity=data_f1['min_humidity'],
    real_humidity=data_f1['real_humidity']
)

# 田块F2的决策
decision_f2 = irrigation_service.make_irrigation_decision(
    field_id='1810564502987649025',
    max_humidity=data_f2['max_humidity'],
    min_humidity=data_f2['min_humidity'],
    real_humidity=data_f2['real_humidity']
)
```

### 7.3 共享的配置参数

以下参数在所有田块间共享：

1. **模型配置**
   - 作物参数（CROP_PARAMS）
   - 土壤基础参数（SOIL_PARAMS）
   - 生育阶段系数（GROWTH_STAGE_COEFFICIENTS）

2. **决策算法**
   - 灌溉阈值（IRRIGATION_THRESHOLD）
   - 最小有效灌溉量（MIN_EFFECTIVE_IRRIGATION）
   - 最大单次灌溉量（MAX_SINGLE_IRRIGATION）

3. **模型输出**
   - 根系深度数据
   - 生育阶段数据
   - ETref/ETc数据
   - 天气预报数据

### 7.4 田块切换

**前端切换示例：**
```javascript
// 获取田块列表
fetch('/api/fields')
  .then(response => response.json())
  .then(data => {
    const fields = data.data;
    // 显示田块选择器
  });

// 切换到指定田块
function switchField(fieldId) {
  // 获取该田块的土壤数据
  fetch(`/api/soil_data?field_id=${fieldId}`)
    .then(response => response.json())
    .then(data => {
      // 更新显示
    });
  
  // 获取该田块的灌溉决策
  fetch(`/api/irrigation_recommendation?field_id=${fieldId}`)
    .then(response => response.json())
    .then(data => {
      // 更新显示
    });
}
```

### 7.5 批量决策

**批量生成所有田块的灌溉决策：**
```python
def generate_all_field_decisions():
    """为所有田块生成灌溉决策"""
    results = []
    
    for field_config in Config.FIELDS_CONFIG:
        field_id = field_config['field_id']
        device_id = field_config['device_id']
        
        # 获取传感器数据
        soil_sensor = SoilSensor(device_id, field_id)
        sensor_data = soil_sensor.get_current_data()
        
        # 生成决策
        decision = irrigation_service.make_irrigation_decision(
            field_id,
            sensor_data['max_humidity'],
            sensor_data['min_humidity'],
            sensor_data['real_humidity']
        )
        
        results.append({
            'field_name': field_config['field_name'],
            'field_id': field_id,
            'decision': decision
        })
    
    return results
```


---

## 数据流转

### 8.1 系统数据流程图

```
┌─────────────────┐
│  传感器设备      │
│  (IoT Devices)  │
└────────┬────────┘
         │ REST API
         ↓
┌─────────────────┐
│  SoilSensor     │ ← 获取实时数据
│  (设备层)        │ ← 计算SAT/FC/PWP
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ IrrigationService│ ← 计算土壤水分参数
│  (服务层)        │ ← 生成灌溉决策
└────────┬────────┘
         │
         ├─────────→ FAOModel (模型层)
         │           ├─ 计算ETc
         │           ├─ 预测未来需水
         │           └─ 输出根系深度
         │
         ↓
┌─────────────────┐
│   API Routes    │ ← 提供REST接口
│  (接口层)        │ ← 返回JSON数据
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  前端Dashboard   │ ← 数据可视化
│  (展示层)        │ ← 用户交互
└─────────────────┘
```

### 8.2 数据获取流程

#### 8.2.1 传感器数据获取

```python
# 1. 初始化传感器
soil_sensor = SoilSensor(device_id='16031600028481', field_id='1810564502987649024')

# 2. 获取当前数据
sensor_data = soil_sensor.get_current_data()
# 返回: {
#   'max_humidity': 35.5,
#   'min_humidity': 15.2,
#   'real_humidity': 25.8,
#   'sat': 32.0,
#   'fc': 28.5,
#   'pwp': 15.0,
#   'is_real_data': True
# }

# 3. 获取历史数据
history_data = soil_sensor.get_history_humidity_data(days=30)
# 返回: DataFrame with columns ['date', 'soilHumidity10Value', 'soilHumidity20Value', 'soilHumidity30Value']
```

**数据来源：**
- **实时数据**：调用 `/zlapi/irrigationApi/v2/getSoilLast` 接口
- **历史数据**：调用 `/zlapi/soilTestingApi/v1/getDailyAvg` 接口

**数据处理：**
1. API请求（带重试和熔断机制）
2. 数据验证和清洗
3. 统计计算（max/min/mean）
4. 缓存处理（按小时粒度）

#### 8.2.2 模型数据获取

```python
# 1. 初始化FAO模型
fao_model = FAOModel(config)

# 2. 运行模型
fao_model.run_model()
# 生成文件: data/model_output/wheat2024.out

# 3. 读取模型输出
# - 根系深度 (Zr)
# - 作物蒸散量 (ETc)
# - 参考蒸散量 (ETref)
# - 土壤水分 (θ)
```

**模型输入：**
- 天气数据：`data/weather/irrigation_weather.csv`
- 土壤数据：`data/soil/irrigation_soilprofile_sim.csv`
- 作物参数：`CROP_PARAMS`
- 土壤参数：`SOIL_PARAMS`

**模型输出：**
- 主输出文件：`data/model_output/wheat2024.out`
- 摘要文件：`data/model_output/wheat2024.sum`
- 参数文件：`data/model_output/wheat2024.par`

### 8.3 决策生成流程

```python
# 完整的决策生成流程（v1.3.0 更新）
def generate_irrigation_decision(field_id, device_id):
    """生成灌溉决策的完整流程"""
    
    # 步骤1: 获取实时湿度
    soil_sensor = SoilSensor(device_id, field_id)
    sensor_data = soil_sensor.get_current_data()
    real_humidity = sensor_data['real_humidity']
    
    # 步骤2: 初始化灌溉服务
    irrigation_service = IrrigationService(config)
    
    # 步骤3: 确保模型已运行
    irrigation_service._ensure_model_run()
    
    # 步骤4: 生成灌溉决策（SAT/FC/PWP 自动获取）
    decision = irrigation_service.make_irrigation_decision(
        field_id,
        device_id,
        real_humidity
    )
    
    # 步骤5: 返回决策结果
    return decision
```

**关键变更（v1.3.0）：**
- ✅ 不再需要单独获取 max_humidity 和 min_humidity
- ✅ SAT/FC/PWP 在 `calculate_soil_humidity_differences()` 中自动获取
- ✅ 支持田块特定配置（FIELD_DATA_PERIODS）
- ✅ 简化了调用流程，减少出错概率

**数据获取优先级：**
```
1. 检查田块特定配置（FIELD_DATA_PERIODS[field_id]）
   ↓
2. 如果有特定配置，使用田块时间段
   ↓
3. 如果没有，使用全局默认配置（DATA_QUERY_RANGES）
   ↓
4. 从传感器API获取历史数据
   ↓
5. 统计计算 SAT/FC/PWP
```

### 8.4 数据缓存机制

#### 8.4.1 传感器数据缓存

```python
@lru_cache(maxsize=32)
def _get_cached_sensor_data(device_id, field_id, hour_timestamp):
    """按小时粒度缓存传感器数据"""
    soil_sensor = SoilSensor(device_id, field_id)
    return soil_sensor.get_current_data()

# 使用示例
hour_timestamp = datetime.now().strftime('%Y-%m-%d-%H')
sensor_data = _get_cached_sensor_data(device_id, field_id, hour_timestamp)
```

**缓存策略：**
- 缓存粒度：1小时
- 缓存大小：32个条目
- 自动过期：每小时更新

#### 8.4.2 模型运行缓存

```python
def _ensure_model_run(self):
    """确保模型在当天已运行"""
    now = datetime.now()
    if (self._last_model_run is None or 
        self._last_model_run.date() != now.date()):
        self.fao_model.run_model()
        self._last_model_run = now
```

**缓存策略：**
- 缓存粒度：1天
- 每天首次调用时运行模型
- 后续调用使用缓存结果

### 8.5 错误处理机制

#### 8.5.1 API熔断器

```python
circuit_breaker = {
    'failure_count': 0,
    'last_failure_time': None,
    'state': 'closed',  # closed/open/half_open
    'failure_threshold': 5,
    'recovery_timeout': 60
}
```

**状态转换：**
- **closed（关闭）**：正常状态，允许请求
- **open（开启）**：失败次数超过阈值，拒绝请求
- **half_open（半开）**：恢复超时后，尝试恢复

#### 8.5.2 重试机制

```python
retry_strategy = Retry(
    total=2,                    # 重试2次
    backoff_factor=1.0,         # 指数退避
    status_forcelist=(429, 500, 502, 503, 504),
    allowed_methods=("POST",)
)
```

**重试策略：**
- 第1次重试：等待1秒
- 第2次重试：等待2秒
- 最大等待：10秒

#### 8.5.3 降级策略

```python
# 1. 传感器数据降级
if not sensor_data or not sensor_data.get('is_real_data'):
    # 使用默认值
    sensor_data = {
        'sat': Config.DEFAULT_SOIL_PARAMS['sat'],
        'fc': Config.DEFAULT_SOIL_PARAMS['fc'],
        'pwp': Config.DEFAULT_SOIL_PARAMS['pwp']
    }

# 2. 模型数据降级
try:
    root_depth_coeff = get_root_depth_coefficient()
except Exception:
    # 使用默认系数
    root_depth_coeff = Config.DEFAULT_COEFFICIENTS['root_depth']

# 3. 决策降级
if irrigation_amount < MIN_EFFECTIVE_IRRIGATION:
    # 灌溉量过小，不执行
    irrigation_amount = 0
```

### 8.6 日志记录

系统使用loguru进行日志记录，记录关键操作和决策过程。

**日志级别：**
- **INFO**：正常操作流程
- **WARNING**：使用默认值或降级处理
- **ERROR**：错误和异常

**关键日志点：**
```python
# 传感器数据获取
logger.info(f"获取土壤参数: device_id={device_id}, field_id={field_id}")

# 土壤参数计算
logger.info(f"计算得到 SAT: {sat}, FC: {fc}, PWP: {pwp}")

# 灌溉决策
logger.info(f"当前根系深度为{root_depth}m,系数为{coefficient}")
logger.info(f"当前生育阶段为：{current_stage}，应用系数{coefficient}")

# 决策结果
logger.info(f"[NO_IRRIGATION] 水分充足 - third_day_etcadj={third_day_etcadj:.2f}")
logger.info(f"今日需灌溉{irrigation_value:.1f}mm,近期无降雨预报")
```

**日志文件：**
- 应用日志：`logs/app.log`
- 灌溉系统日志：`logs/irrigation_system.log`
- API响应日志：`logs/api_response_*.json`


---

## 附录

### A. 决策示例

#### 示例1：水分充足，不需要灌溉

**输入条件：**
- 当前湿度：28.5%
- 田间持水量（FC）：25.0%
- 萎蔫点（PWP）：15.2%
- 未来3天累积ETc：8.5mm
- 转换系数：3.0（土壤深度30cm，根系系数1.0，生育阶段系数1.0）

**决策过程：**
```
1. 计算可用水量（mm）：
   diff_min_real_mm = (28.5 - 15.2) × 3.0 = 39.9mm
   
2. 判断临界水分：39.9mm > 0 ✓
   
3. 计算阈值水量：
   threshold_water = 39.9 × 0.6 = 23.94mm
   
4. 判断水分充足：
   third_day_ETc (8.5mm) ≤ threshold_water (23.94mm) ✓
```

**决策结果：**
```json
{
  "irrigation_amount": 0,
  "message": "水分充足，今日不灌溉"
}
```

---

#### 示例2：水分不足，需要灌溉

**输入条件：**
- 当前湿度：18.5%
- 田间持水量（FC）：25.0%
- 萎蔫点（PWP）：15.2%
- 未来3天累积ETc：12.5mm
- 转换系数：3.0

**决策过程：**
```
1. 计算可用水量（mm）：
   diff_min_real_mm = (18.5 - 15.2) × 3.0 = 9.9mm
   diff_com_real_mm = (25.0 - 18.5) × 3.0 = 19.5mm
   
2. 判断临界水分：9.9mm > 0 ✓
   
3. 计算阈值水量：
   threshold_water = 9.9 × 0.6 = 5.94mm
   
4. 判断水分充足：
   third_day_ETc (12.5mm) > threshold_water (5.94mm) ✗
   
5. 检查降雨预报：无降雨
   
6. 计算灌溉量：
   irrigation = min(
     diff_com_real_mm (19.5mm),           # 补充到FC
     12.5 - 5.94 = 6.56mm,                # 满足3天需水
     MAX_SINGLE_IRRIGATION (30mm)         # 单次最大限制
   ) = 6.56mm
   
7. 量化处理：向上取整到10mm
   
8. 判断有效性：10mm ≥ MIN_EFFECTIVE (5mm) ✓
```

**决策结果：**
```json
{
  "irrigation_amount": 10,
  "message": "今日需灌溉10.0mm,近期无降雨预报"
}
```

---

#### 示例3：临界水分，立即灌溉

**输入条件：**
- 当前湿度：14.8%
- 田间持水量（FC）：25.0%
- 萎蔫点（PWP）：15.2%
- 转换系数：3.0

**决策过程：**
```
1. 计算可用水量（mm）：
   diff_min_real_mm = (14.8 - 15.2) × 3.0 = -1.2mm
   diff_com_real_mm = (25.0 - 14.8) × 3.0 = 30.6mm
   
2. 判断临界水分：-1.2mm ≤ 0 ✓
   （当前湿度已低于萎蔫点）
   
3. 立即灌溉决策（跳过其他判断）
   
4. 计算灌溉量：
   irrigation = min(
     diff_com_real_mm (30.6mm),           # 补充到FC
     MAX_SINGLE_IRRIGATION (30mm)         # 单次最大限制
   ) = 30mm
   
5. 量化处理：30mm（已在档位内）
```

**决策结果：**
```json
{
  "irrigation_amount": 30,
  "message": "土壤水分已达临界水平，立即灌溉"
}
```

---

#### 示例4：有降雨预报，延迟灌溉

**输入条件：**
- 当前湿度：19.5%
- 田间持水量（FC）：25.0%
- 萎蔫点（PWP）：15.2%
- 未来3天累积ETc：11.5mm
- 第2天降雨预报：8.0mm
- 转换系数：3.0

**决策过程：**
```
1. 计算可用水量（mm）：
   diff_min_real_mm = (19.5 - 15.2) × 3.0 = 12.9mm
   
2. 判断临界水分：12.9mm > 0 ✓
   
3. 计算阈值水量：
   threshold_water = 12.9 × 0.6 = 7.74mm
   
4. 判断水分充足：
   third_day_ETc (11.5mm) > threshold_water (7.74mm) ✗
   
5. 检测降雨预报：
   - 第2天有降雨
   - 降雨量：8.0mm
   - 距离降雨天数：2天
   
6. 判断有效降雨：
   - 8.0mm ≥ MIN_RAIN_AMOUNT (5.0mm) ✓
   - 2天 ≤ RAIN_FORECAST_DAYS (3天) ✓
   
7. 决策：延迟灌溉
```

**决策结果：**
```json
{
  "irrigation_amount": 0,
  "message": "未来2天内有8.0mm降雨,延迟灌溉"
}
```

---

### B. 重要说明与注意事项

#### B.1 土壤参数的理解

**关键概念澄清：**

1. **传感器数据 vs 计算结果**
   - 传感器返回的是**百分比值**（%）：SAT%, FC%, PWP%
   - 灌溉决策使用的是**毫米值**（mm）：SAT_mm, FC_mm, PWP_mm
   - 转换公式：`mm值 = 百分比值 × 转换系数`

2. **转换系数的作用**
   ```python
   conversion_factor = (soil_depth / 10) × root_depth_coeff × growth_stage_coeff
   
   # 示例：
   # 土壤深度 = 30cm
   # 根系系数 = 1.0（根深≥0.3m）
   # 生育阶段系数 = 1.0（拔节-抽穗期）
   # 转换系数 = (30/10) × 1.0 × 1.0 = 3.0
   ```

3. **可用水量的计算**
   ```python
   # 正确的计算方式
   diff_min_real_mm = (real_humidity% - PWP%) × conversion_factor
   diff_com_real_mm = (FC% - real_humidity%) × conversion_factor
   
   # 示例：
   # 当前湿度 = 20%，PWP = 15%，FC = 25%，转换系数 = 3.0
   # diff_min_real_mm = (20 - 15) × 3.0 = 15mm（可用水量）
   # diff_com_real_mm = (25 - 20) × 3.0 = 15mm（可补充水量）
   ```

#### B.2 决策逻辑的关键点

**1. 临界判断优先级最高**
```python
if diff_min_real_mm <= 0:
    # 当前湿度 ≤ 萎蔫点，立即灌溉
    irrigation = min(diff_com_real_mm, MAX_SINGLE_IRRIGATION)
```
- 这是最紧急的情况，跳过所有其他判断
- 直接补充到田间持水量

**2. 水分充足判断**
```python
if third_day_ETc <= diff_min_real_mm × irrigation_threshold:
    # 可用水量足够支撑3天
    irrigation = 0
```
- `diff_min_real_mm` 是当前可用水量（到萎蔫点的距离）
- `irrigation_threshold` 是安全系数（默认0.6）
- 只有当3天累积ETc小于安全水量时才不灌溉

**3. 降雨判断的细节**
```python
# 有效降雨的条件
if days_to_rain <= 3 and rain_amount >= 5.0:
    # 延迟灌溉
    
# 远期降雨或小雨
elif days_to_rain > 3 or rain_amount < 5.0:
    # 计算部分灌溉量
    irrigation = cumulative_ETc_until_rain - available_water × threshold
```

**4. 常规灌溉计算**
```python
irrigation = min(
    diff_com_real_mm,                              # 不超过FC
    third_day_ETc - diff_min_real_mm × threshold,  # 满足3天需水
    MAX_SINGLE_IRRIGATION                          # 不超过单次最大量
)
```

#### B.3 容易混淆的概念

| 概念 | 说明 | 单位 | 用途 |
|------|------|------|------|
| max_humidity | 传感器历史最大湿度 | % | 用于计算SAT |
| min_humidity | 传感器历史最小湿度 | % | 用于计算PWP |
| real_humidity | 当前实时湿度 | % | 当前状态 |
| SAT | 饱和含水量（计算值） | mm | 土壤最大储水能力 |
| FC | 田间持水量（计算值） | mm | 灌溉目标值 |
| PWP | 萎蔫点（计算值） | mm | 临界水分线 |
| diff_min_real_mm | 可用水量 | mm | 当前到PWP的距离 |
| diff_com_real_mm | 可补充水量 | mm | 当前到FC的距离 |

#### B.4 已知的设计权衡

**1. 为什么使用第3天的累积ETc？**
- 提供3天的决策窗口
- 避免频繁灌溉
- 考虑天气预报的准确性

**2. 为什么有灌溉量分档？**
- 实际灌溉设备的操作限制
- 便于农户执行
- 减少过度精确带来的复杂性

**3. 为什么设置最小有效灌溉量（5mm）？**
- 低于5mm的灌溉效果不明显
- 避免频繁小量灌溉
- 节省人力和能源成本

**4. 为什么传感器数据和入参数据可能不一致？**
- 传感器数据（SAT/FC/PWP）是从历史数据统计得出
- 入参数据（max/min_humidity）是用于兼容性的历史接口
- 实际决策优先使用传感器统计的SAT/FC/PWP值

---

### C. 逻辑验证检查清单

在使用或修改系统时，请注意以下逻辑要点：

#### ✓ 数据单位一致性
- [ ] 传感器返回的是百分比（%）
- [ ] 决策计算使用的是毫米（mm）
- [ ] 转换系数正确应用
- [ ] API返回数据单位标注清楚

#### ✓ 参数来源正确性
- [ ] SAT/FC/PWP来自传感器统计数据
- [ ] 不是直接使用max_humidity/min_humidity作为SAT/PWP
- [ ] 转换系数包含土壤深度、根系系数、生育阶段系数
- [ ] 缓存机制按小时粒度更新

#### ✓ 决策逻辑完整性
- [ ] 临界判断（diff_min_real_mm ≤ 0）优先级最高
- [ ] 水分充足判断使用阈值系数
- [ ] 降雨判断考虑时间和雨量
- [ ] 灌溉量计算考虑三个限制（FC、ETc、MAX）

#### ✓ 边界条件处理
- [ ] 传感器数据不可用时使用默认值
- [ ] 模型文件不存在时使用默认系数
- [ ] 灌溉量小于5mm时设为0
- [ ] 灌溉量量化到预定义档位

#### ✓ 降级策略完备性
- [ ] API熔断器正常工作
- [ ] 重试机制配置合理
- [ ] 默认值配置完整
- [ ] 日志记录关键决策点

---

### D. 常见问题

#### Q1: 为什么SAT、FC、PWP的值会变化？

**A:** 这三个参数是基于传感器历史数据统计得出的：
- **SAT**：取历史最大值，会随着极端湿润事件更新
- **FC**：取特定时段平均值（10月15-31日），反映灌溉后稳定状态
- **PWP**：取历史最小值，会随着极端干旱事件更新

**注意：** 这些值是百分比，需要通过转换系数转换为毫米值用于决策。

建议定期（如每季度）更新这些参数以反映土壤实际特性。

---

#### Q2: 灌溉阈值如何选择？

**A:** 灌溉阈值（默认0.6）表示当可用水量低于60%时触发灌溉。该值会根据生育阶段动态调整：

- **关键期**（拔节-抽穗期）：系数1.0，阈值0.6（最严格）
- **一般期**（返青-拔节期）：系数0.9，阈值0.54
- **非关键期**（播种-出苗期）：系数0.6，阈值0.36（最宽松）

可根据作物类型、土壤质地、气候条件调整基础阈值。

---

#### Q3: 为什么有时计算的灌溉量会被设为0？

**A:** 有以下几种情况：
1. 计算灌溉量小于最小有效灌溉量（5mm）
2. 未来3天内有有效降雨预报（≥5mm）
3. 当前土壤水分充足，可支撑未来3天需水
4. 传感器数据异常或不可用

---

#### Q4: 如何处理传感器数据异常？

**A:** 系统有多层降级机制：
1. **API重试**：失败后自动重试2次
2. **熔断器**：连续失败5次后暂停请求60秒
3. **默认值**：无法获取数据时使用配置的默认值
4. **数据验证**：检查数据范围和逻辑关系

建议定期检查传感器状态和数据质量。

---

#### Q5: 多田块如何管理？

**A:** 系统支持多田块独立管理：
1. 在`FIELDS_CONFIG`中配置多个田块
2. 每个田块有独立的`field_id`和`device_id`
3. 通过API参数`field_id`切换不同田块
4. 每个田块有独立的传感器数据和灌溉决策
5. 共享相同的模型配置和决策算法

---

### C. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 饱和含水量 | SAT (Saturation) | 土壤孔隙完全充满水时的含水量 |
| 田间持水量 | FC (Field Capacity) | 重力水排出后土壤保持的水量 |
| 萎蔫点 | PWP (Permanent Wilting Point) | 植物永久萎蔫时的土壤含水量 |
| 参考蒸散量 | ET0 (Reference Evapotranspiration) | 标准草地的蒸散量 |
| 作物蒸散量 | ETc (Crop Evapotranspiration) | 特定作物的实际蒸散量 |
| 作物系数 | Kc (Crop Coefficient) | 作物蒸散量与参考蒸散量的比值 |
| 根系深度 | Zr (Root Depth) | 作物根系的有效深度 |
| 生育阶段 | Growth Stage | 作物生长发育的不同时期 |
| 土壤水分胁迫 | Water Stress | 土壤水分不足对作物生长的限制 |
| 灌溉阈值 | Irrigation Threshold | 触发灌溉决策的水分临界值 |

---

### D. 参考文献

1. Allen, R.G., Pereira, L.S., Raes, D., & Smith, M. (1998). **Crop evapotranspiration - Guidelines for computing crop water requirements**. FAO Irrigation and drainage paper 56. Rome: FAO.

2. Steduto, P., Hsiao, T.C., Raes, D., & Fereres, E. (2012). **Crop yield response to water**. FAO Irrigation and drainage paper 66. Rome: FAO.

3. Doorenbos, J., & Kassam, A.H. (1979). **Yield response to water**. FAO Irrigation and drainage paper 33. Rome: FAO.

4. 中国农业科学院. (2015). **冬小麦节水高效灌溉技术规程**. 北京：中国农业出版社.

5. 山仑, 康绍忠. (2010). **中国节水农业**. 北京：中国农业出版社.

---

### E. 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2024-07 | 初始版本，实现基础灌溉决策功能 |
| 1.1.0 | 2024-10 | 增加多田块管理功能 |
| 1.2.0 | 2024-11 | 优化传感器数据获取和缓存机制 |
| 1.3.0 | 2024-12 | 增加降雨预报判断逻辑 |

---

### F. 联系方式

**技术支持：** 请通过系统日志和API接口进行问题诊断

**配置修改：** 编辑 `config.py` 文件中的相关配置项

**数据备份：** 定期备份 `data/` 目录下的所有数据文件

---

**文档生成时间：** 2024年11月17日

**文档版本：** v1.0

**适用系统版本：** drought_smart_irrigation v1.3.0



---

### E. 故障排查

#### E.1 常见错误

**错误1：TypeError: make_irrigation_decision() takes 4 positional arguments but 5 were given**

**原因：** 使用了旧版本的API调用方式

**解决：**
```python
# ❌ 错误的调用（旧版本）
result = make_irrigation_decision(field_id, max_humidity, min_humidity, real_humidity)

# ✅ 正确的调用（v1.3.0）
result = make_irrigation_decision(field_id, device_id, real_humidity)
```

---

**错误2：AttributeError: type object 'Config' has no attribute 'get_field_data_periods'**

**原因：** Config类中缺少该方法

**解决：** 在 config.py 中添加：
```python
class Config:
    # ... 其他配置 ...
    
    @staticmethod
    def get_field_data_periods(field_id):
        """获取田块特定的数据查询时间段配置"""
        if not field_id:
            return None
        return Config.FIELD_DATA_PERIODS.get(field_id)
```

---

**错误3：ETref和ETc数据文件不存在**

**原因：** 模型尚未运行或输出文件路径错误

**解决：**
1. 运行FAO模型：`python run_model.py`
2. 检查文件是否存在：`data/model_output/wheat2024.out`
3. 检查配置路径：`Config.FILE_PATHS['model_output']`

---

**错误4：无法获取有效的土壤数据**

**原因：** 传感器API调用失败或数据为空

**解决：**
1. 检查传感器API是否可访问
2. 检查 device_id 和 field_id 是否正确
3. 查看日志中的详细错误信息
4. 确认默认值配置（SOIL_SENSOR_DEFAULTS）

---

**错误5：灌溉量计算异常**

**原因：** 土壤参数或转换系数异常

**排查步骤：**
```python
# 1. 检查传感器数据
sensor_data = soil_sensor.get_current_data()
print(f"SAT: {sensor_data['sat']}%, FC: {sensor_data['fc']}%, PWP: {sensor_data['pwp']}%")

# 2. 检查转换系数
print(f"土壤深度: {soil_depth}cm")
print(f"根系系数: {root_depth_coefficient}")
print(f"生育阶段系数: {growth_stage_coefficient}")

# 3. 检查计算结果
print(f"SAT: {SAT}mm, FC: {FC}mm, PWP: {PWP}mm")
print(f"可用水量: {diff_min_real_mm}mm")
```

---

### F. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 饱和含水量 | SAT (Saturation) | 土壤孔隙完全充满水时的含水量 |
| 田间持水量 | FC (Field Capacity) | 重力水排出后土壤保持的水量 |
| 萎蔫点 | PWP (Permanent Wilting Point) | 植物永久萎蔫时的土壤含水量 |
| 参考蒸散量 | ET0 (Reference Evapotranspiration) | 标准草地的蒸散量 |
| 作物蒸散量 | ETc (Crop Evapotranspiration) | 特定作物的实际蒸散量 |
| 作物系数 | Kc (Crop Coefficient) | 作物蒸散量与参考蒸散量的比值 |
| 根系深度 | Zr (Root Depth) | 作物根系的有效深度 |
| 生育阶段 | Growth Stage | 作物生长发育的不同时期 |
| 土壤水分胁迫 | Water Stress | 土壤水分不足对作物生长的限制 |
| 灌溉阈值 | Irrigation Threshold | 触发灌溉决策的水分临界值 |
| 转换系数 | Conversion Factor | 将百分比转换为毫米的系数 |
| 可用水量 | Available Water | 当前湿度到萎蔫点的水量（mm） |
| 可补充水量 | Refillable Water | 田间持水量到当前湿度的水量（mm） |

---

### F. 参考文献

1. Allen, R.G., Pereira, L.S., Raes, D., & Smith, M. (1998). **Crop evapotranspiration - Guidelines for computing crop water requirements**. FAO Irrigation and drainage paper 56. Rome: FAO.

2. Steduto, P., Hsiao, T.C., Raes, D., & Fereres, E. (2012). **Crop yield response to water**. FAO Irrigation and drainage paper 66. Rome: FAO.

3. Doorenbos, J., & Kassam, A.H. (1979). **Yield response to water**. FAO Irrigation and drainage paper 33. Rome: FAO.

4. 中国农业科学院. (2015). **冬小麦节水高效灌溉技术规程**. 北京：中国农业出版社.

5. 山仑, 康绍忠. (2010). **中国节水农业**. 北京：中国农业出版社.

---

### G. 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2024-07 | 初始版本，实现基础灌溉决策功能 |
| 1.1.0 | 2024-10 | 增加多田块管理功能 |
| 1.2.0 | 2024-11 | 优化传感器数据获取和缓存机制 |
| 1.3.0 | 2024-12 | 增加降雨预报判断逻辑 |

---

### H. 联系方式

**技术支持：** 请通过系统日志和API接口进行问题诊断

**配置修改：** 编辑 `config.py` 文件中的相关配置项

**数据备份：** 定期备份 `data/` 目录下的所有数据文件

---

**文档生成时间：** 2024年11月17日

**文档版本：** v1.0

**适用系统版本：** drought_smart_irrigation v1.3.0



---

## 版本变更记录

### v1.3.0 (2024-11-17)

**重大变更：**

1. ✅ **重构灌溉决策函数签名**
   - 移除 `max_humidity` 和 `min_humidity` 参数
   - 添加 `device_id` 参数
   - SAT/FC/PWP 自动从传感器获取

2. ✅ **添加田块特定配置支持**
   - 新增 `FIELD_DATA_PERIODS` 配置
   - 新增 `get_field_data_periods()` 方法
   - 支持不同田块使用不同的数据查询时间段

3. ✅ **优化数据获取流程**
   - 统一数据来源
   - 减少参数传递
   - 提高代码可维护性

**API变更：**
```python
# 旧版本
make_irrigation_decision(field_id, max_humidity, min_humidity, real_humidity)
calculate_soil_humidity_differences(max_humidity, real_humidity, min_humidity)

# v1.3.0
make_irrigation_decision(field_id, device_id, real_humidity)
calculate_soil_humidity_differences(field_id, device_id, real_humidity)
```

**配置变更：**
- 新增 `FIELD_DATA_PERIODS` 配置项（可选）
- 保留 `DATA_QUERY_RANGES` 作为全局默认配置（必需）

**向后兼容性：**
- ⚠️ 不兼容：需要更新所有调用 `make_irrigation_decision()` 的代码
- ✅ 兼容：配置文件向后兼容，旧配置仍然有效

**升级指南：**
```python
# 步骤1：更新API调用
# 旧代码
sensor_data = soil_sensor.get_current_data()
result = irrigation_service.make_irrigation_decision(
    field_id,
    sensor_data['max_humidity'],
    sensor_data['min_humidity'],
    sensor_data['real_humidity']
)

# 新代码
sensor_data = soil_sensor.get_current_data()
result = irrigation_service.make_irrigation_decision(
    field_id,
    device_id,
    sensor_data['real_humidity']
)

# 步骤2：（可选）添加田块特定配置
# 在 config.py 中添加
FIELD_DATA_PERIODS = {
    'your_field_id': {
        'sat_pwp': {
            'start_date': '2024-07-01',
            'end_date': None
        },
        'fc': {
            'start_date': '2024-10-15',
            'end_date': '2024-10-31'
        }
    }
}

# 步骤3：添加 get_field_data_periods 方法
@staticmethod
def get_field_data_periods(field_id):
    if not field_id:
        return None
    return Config.FIELD_DATA_PERIODS.get(field_id)
```

---

### v1.2.0 (2024-11)
- 优化传感器数据获取和缓存机制
- 添加按小时粒度的数据缓存
- 改进API重试和熔断器机制

### v1.1.0 (2024-10)
- 增加多田块管理功能
- 支持田块列表API
- 优化前端田块切换

### v1.0.0 (2024-07)
- 初始版本发布
- 实现基础灌溉决策功能
- 集成FAO-56模型
- 实现传感器数据获取

---

**文档最后更新：** 2024年11月17日

**文档版本：** v1.3.0

**适用系统版本：** drought_smart_irrigation v1.3.0
